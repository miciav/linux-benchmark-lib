name: Generate Diagrams

on:
  release:
    types: [published]

jobs:
  diagrams:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Graphviz
        run: sudo apt-get update && sudo apt-get install -y graphviz

      - name: Install pyreverse dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install pylint

      - name: Generate diagrams
        run: |
          mkdir -p docs/diagrams
          pyreverse -o png -p linux-benchmark lb_runner lb_controller lb_ui -S
          mv classes.png docs/diagrams/classes.png
          mv packages.png docs/diagrams/packages.png
          pyreverse -o puml -p linux-benchmark lb_runner lb_controller lb_ui -S
          mv classes.puml docs/diagrams/classes.puml
          mv packages.puml docs/diagrams/packages.puml

      - name: Upload diagrams artifact
        uses: actions/upload-artifact@v4
        with:
          name: diagrams-${{ github.ref_name }}
          path: docs/diagrams
          if-no-files-found: error
