# Use the official uv base image matching the project's Python version
FROM ghcr.io/astral-sh/uv:python3.13-bookworm-slim

# Install system dependencies required by the benchmark tools
# Do this early as it's less likely to change than app code
# BEGIN GENERATED PLUGIN PACKAGES
# This section is auto-generated by tools/gen_plugin_assets.py; do not edit manually.
RUN apt-get update && apt-get install -y \
    fio \
    git \
    gzip \
    iperf3 \
    procps \
    stress-ng \
    sysbench \
    sysstat \
    tar \
    wget \
    --no-install-recommends && \
    rm -rf /var/lib/apt/lists/*
# END GENERATED PLUGIN PACKAGES

# Set the working directory
WORKDIR /app

# Set uv environment variables for optimal container builds
ENV UV_COMPILE_BYTECODE=1
ENV UV_LINK_MODE=copy

# Copy dependency metadata first for better caching
COPY pyproject.toml uv.lock /app/

# Install dependencies (all groups) using the lockfile
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --locked --all-groups

# Ensure jc is at a version with the sar parser (override lock if needed)
ARG JC_VERSION=1.25.0
RUN --mount=type=cache,target=/root/.cache/uv \
    uv pip install -U "jc==${JC_VERSION}"

# Add the virtual environment's bin directory to the PATH
ENV PATH="/app/.venv/bin:$PATH"

# Copy the rest of the project
COPY . /app

# Reset the entrypoint from the base image
ENTRYPOINT []

# Default command - run tests inside the managed venv
CMD ["uv", "run", "pytest", "tests/"]
