---
- name: Prepare and run Top500 benchmark playbook from controller
  hosts: localhost
  gather_facts: false
  vars:
    top500_repo_url: "{{ top500_repo_url | default('https://github.com/geerlingguy/top500-benchmark.git') }}"
    top500_repo_ref: "{{ top500_repo_ref | default(omit) }}"
    top500_workdir: "{{ top500_workdir | default('/opt/top500-benchmark') }}"
    top500_tags: "{{ top500_tags | default(['setup', 'benchmark']) }}"
    top500_config_overrides: "{{ top500_config_overrides | default({}) }}"
    top500_inventory_path: "{{ _lb_inventory_path | default(inventory_file | default('inventory.ini')) }}"

  tasks:
    - name: Ensure Top500 repository is cloned
      ansible.builtin.git:
        repo: "{{ top500_repo_url }}"
        dest: "{{ top500_workdir }}"
        version: "{{ top500_repo_ref | default(omit) }}"
        depth: 1

    - name: Check if config.yml exists
      ansible.builtin.stat:
        path: "{{ top500_workdir }}/config.yml"
      register: top500_config_stat

    - name: Ensure config.yml exists
      ansible.builtin.copy:
        src: "{{ top500_workdir }}/example.config.yml"
        dest: "{{ top500_workdir }}/config.yml"
        remote_src: true
      when: not top500_config_stat.stat.exists

    - name: Apply config overrides
      ansible.builtin.copy:
        dest: "{{ top500_workdir }}/config.yml"
        content: >-
          {{ (lookup('file', top500_workdir + '/config.yml') | from_yaml)
             | combine(top500_config_overrides, recursive=True)
             | to_nice_yaml }}
      when: top500_config_overrides | length > 0

    - name: Run upstream Top500 playbook with controller inventory
      ansible.builtin.command: >-
        ansible-playbook -i "{{ top500_inventory_path }}"
        main.yml
        --tags "{{ top500_tags | join(',') }}"
      args:
        chdir: "{{ top500_workdir }}"
      environment:
        ANSIBLE_CONFIG: "{{ top500_workdir }}/ansible.cfg"
      register: top500_result
      changed_when: top500_result.rc == 0
      failed_when: top500_result.rc != 0
