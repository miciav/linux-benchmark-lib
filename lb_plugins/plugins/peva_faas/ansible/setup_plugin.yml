---
# This playbook orchestrates the setup of BOTH the runner (k6) and the k3s/OpenFaaS node.
# It requires `benchmark_config` to be passed as an extra var (provided by lb_controller).
#
# Architecture:
#   - Play 1: Register k3s host dynamically from benchmark_config
#   - Play 2: Install k6 on runner/target hosts
#   - Play 3: Configure k3s/OpenFaaS/Prometheus on the k3s node

- name: Register K3s Host from Config
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    - name: Parse k3s host from config
      ansible.builtin.set_fact:
        k3s_host_address: "{{ (benchmark_config.plugin_settings.peva_faas.k3s_host | default('')) }}"
        k3s_user: "{{ (benchmark_config.plugin_settings.peva_faas.k3s_user | default('ubuntu')) }}"
        k3s_ssh_key: "{{ (benchmark_config.plugin_settings.peva_faas.k3s_ssh_key | default('')) }}"
        k3s_port: "{{ (benchmark_config.plugin_settings.peva_faas.k3s_port | default(22)) }}"

    - name: Add k3s host to inventory
      ansible.builtin.add_host:
        name: "{{ k3s_host_address }}"
        groups: k3s_nodes
        ansible_user: "{{ k3s_user }}"
        ansible_ssh_private_key_file: "{{ k3s_ssh_key | regex_replace('^~', lookup('env', 'HOME')) }}"
        ansible_port: "{{ k3s_port }}"
        ansible_ssh_common_args: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
        ansible_python_interpreter: "/usr/bin/python3"
      when: k3s_host_address | length > 0

- name: Configure K6 Runner
  hosts: all:!k3s_nodes:!localhost
  become: true
  gather_facts: true
  vars_files:
    - vars/k6.yml
  tasks:
    - name: Install k6
      ansible.builtin.import_tasks: tasks/install_k6.yml
    - name: Install faas-cli
      ansible.builtin.shell: "curl -sSL https://cli.openfaas.com | sh"
      args:
        creates: "/usr/local/bin/faas-cli"

- name: Configure K3s/OpenFaaS Node
  hosts: k3s_nodes
  become: true
  gather_facts: true
  vars_files:
    - vars/target.yml
  vars:
    benchmark_config: "{{ benchmark_config | default({}) }}"
  tasks:
    - name: Setup k3s/OpenFaaS/Prometheus
      ansible.builtin.import_tasks: tasks/setup_k3s_tasks.yml
