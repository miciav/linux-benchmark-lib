- name: Find generator logs on DFaaS k6 host
  ansible.builtin.find:
    paths: "{{ hostvars.get('peva_faas_k6', {}).get('k6_workspace_root', '') }}"
    patterns: "k6.log"
    recurse: true
    file_type: file
  register: peva_faas_k6_log_files
  failed_when: false
  changed_when: false
  delegate_to: peva_faas_k6
  run_once: true
  when:
    - "'peva_faas_k6' in hostvars"

- name: Fetch generator logs to controller
  ansible.builtin.fetch:
    src: "{{ item.path }}"
    dest: "{{ output_root | default('./benchmark_results') }}/logs/k6/peva_faas_k6/"
    flat: false
  loop: "{{ peva_faas_k6_log_files.files | default([]) }}"
  loop_control:
    label: "{{ item.path | default('') }}"
  failed_when: false
  delegate_to: peva_faas_k6
  run_once: true
  when:
    - "'peva_faas_k6' in hostvars"

- name: Derive PEVA-FAAS memory DB path
  ansible.builtin.set_fact:
    peva_faas_memory_db_path_raw: >-
      {{
        (
          (
            (
              (benchmark_config.plugin_settings | default({})).peva_faas
              | default({})
            ).memory
            | default({})
          ).db_path
          | default('benchmark_results/peva_faas/memory/peva_faas.duckdb')
        )
      }}

- name: Resolve PEVA-FAAS memory DB absolute path
  ansible.builtin.set_fact:
    peva_faas_memory_db: >-
      {{
        (peva_faas_memory_db_path_raw | string).startswith('/')
        | ternary(
            peva_faas_memory_db_path_raw,
            lb_workdir ~ '/' ~ peva_faas_memory_db_path_raw
          )
      }}

- name: Guard PEVA-FAAS memory DB path is safe
  ansible.builtin.assert:
    that:
      - peva_faas_memory_db_path_raw is string
      - not (peva_faas_memory_db_path_raw | regex_search('(^|/)\\.\\.(?:/|$)'))
    fail_msg: "PEVA-FAAS memory DB path cannot contain '..' segments."

- name: Check PEVA-FAAS memory DB exists
  ansible.builtin.stat:
    path: "{{ peva_faas_memory_db }}"
  register: peva_faas_memory_db_stat
  changed_when: false
  failed_when: false

- name: Fetch PEVA-FAAS memory DB to controller
  ansible.builtin.fetch:
    src: "{{ peva_faas_memory_db }}"
    dest: "{{ output_root | default('./benchmark_results') }}/memory/{{ inventory_hostname }}/"
    flat: false
  failed_when: false
  when:
    - peva_faas_memory_db_stat.stat.exists | default(false)
