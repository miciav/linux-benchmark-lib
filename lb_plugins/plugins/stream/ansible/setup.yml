---
- name: Install STREAM (stream-benchmark) from prebuilt package
  hosts: all
  gather_facts: true
  become: true

  vars:
    stream_version: "5.10"
    stream_arch_map:
      x86_64: amd64
      amd64: amd64
      aarch64: arm64
      arm64: arm64
    stream_arch: "{{ stream_arch_map.get(ansible_facts['architecture'] | default('amd64'), 'amd64') }}"
    stream_deb_default: "{{ playbook_dir + '/../stream-benchmark_' + stream_version + '-1_' + stream_arch + '.deb' }}"
    stream_deb_src_resolved: "{{ stream_deb_src | default(stream_deb_default, true) }}"
    stream_deb_dest: "/tmp/stream-benchmark_{{ stream_version }}.deb"
    stream_workspace: "{{ ansible_facts['env']['HOME'] + '/.lb/workspaces/stream' }}"

    stream_packages:
      - libgomp1
      - gcc
      - make
      - procps
      - sysstat
      - numactl

  tasks:
    - name: Abort on unsupported OS family
      ansible.builtin.fail:
        msg: "STREAM .deb install is supported on Debian/Ubuntu only."
      when: ansible_facts['os_family'] | default('') != 'Debian'

    - name: Install STREAM runtime/build dependencies
      ansible.builtin.apt:
        name: "{{ stream_packages }}"
        state: present
        update_cache: true

    - name: Validate STREAM package source exists on controller
      delegate_to: localhost
      run_once: true
      become: false
      ansible.builtin.stat:
        path: "{{ stream_deb_src_resolved }}"
      register: stream_deb_src_stat

    - name: Fail if STREAM package is missing
      ansible.builtin.fail:
        msg: >-
          STREAM .deb not found at {{ stream_deb_src_resolved }}.
          Build it via Docker Buildx (see plugin README) or override stream_deb_src.
      when: not stream_deb_src_stat.stat.exists

    - name: Copy STREAM package to target
      ansible.builtin.copy:
        src: "{{ stream_deb_src_resolved }}"
        dest: "{{ stream_deb_dest }}"
        mode: "0644"

    - name: Install STREAM package
      ansible.builtin.apt:
        deb: "{{ stream_deb_dest }}"
        state: present
        update_cache: true

    - name: Ensure workspace bin directory exists
      ansible.builtin.file:
        path: "{{ stream_workspace }}/stream-{{ stream_version }}/bin"
        state: directory
        mode: "0755"

    - name: Copy stream binary into workspace for convenience
      ansible.builtin.copy:
        src: "/opt/stream-{{ stream_version }}/bin/stream"
        dest: "{{ stream_workspace }}/stream-{{ stream_version }}/bin/stream"
        mode: "0755"
        remote_src: true

