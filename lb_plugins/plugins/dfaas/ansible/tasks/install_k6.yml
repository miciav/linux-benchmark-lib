---
- name: Install apt dependencies
  ansible.builtin.apt:
    name:
      - ca-certificates
      - gnupg
    state: present
    update_cache: true

- name: Ensure keyring directory exists
  ansible.builtin.file:
    path: "/usr/share/keyrings"
    state: directory
    mode: "0755"

- name: Check for k6 repository key
  ansible.builtin.command: >-
    gpg --no-default-keyring
    --keyring {{ k6_keyring_path }}
    --list-keys {{ k6_key_fingerprint }}
  register: k6_key_check
  changed_when: false
  failed_when: false

- name: Install k6 repository key from keyserver
  ansible.builtin.command: >-
    gpg --no-default-keyring
    --keyring {{ k6_keyring_path }}
    --keyserver {{ k6_keyserver }}
    --recv-keys {{ k6_key_fingerprint }}
  register: k6_key_import
  failed_when: false
  when: k6_key_check.rc != 0

- name: Download k6 repository key (fallback)
  ansible.builtin.get_url:
    url: "{{ k6_key_url }}"
    dest: "/tmp/k6-archive-key.gpg"
    mode: "0644"
    timeout: 30
    force: true
  register: k6_key_download
  retries: 3
  delay: 5
  until: k6_key_download is succeeded
  when:
    - k6_key_check.rc != 0
    - k6_key_import is not defined or k6_key_import.rc != 0

- name: Dearmor k6 repository key
  ansible.builtin.command: >-
    gpg --dearmor --yes --output {{ k6_keyring_path }} /tmp/k6-archive-key.gpg
  register: k6_key_dearmor
  changed_when: true
  when:
    - k6_key_check.rc != 0
    - k6_key_import is not defined or k6_key_import.rc != 0
    - k6_key_download is defined and k6_key_download is succeeded

- name: Ensure k6 keyring is readable by apt
  ansible.builtin.file:
    path: "{{ k6_keyring_path }}"
    owner: "root"
    group: "root"
    mode: "0644"
  when: >
    k6_key_check.rc == 0
    or (k6_key_import is defined and k6_key_import.rc == 0)
    or (k6_key_dearmor is defined and k6_key_dearmor.rc == 0)

- name: Add k6 APT repository
  ansible.builtin.apt_repository:
    repo: "{{ k6_repo }}"
    filename: "k6"
    state: present
    update_cache: true

- name: Check k6 package availability in APT
  ansible.builtin.command: apt-cache policy k6
  register: k6_apt_policy
  changed_when: false
  failed_when: false

- name: Set k6 APT availability flag
  ansible.builtin.set_fact:
    k6_apt_available: >-
      {{
        ('Candidate:' in k6_apt_policy.stdout)
        and ('Candidate: (none)' not in k6_apt_policy.stdout)
      }}

# Try APT first, fall back to tarball if APT fails
- name: Install k6 via APT
  ansible.builtin.apt:
    name: k6
    state: present
    update_cache: true
  register: k6_apt_install
  ignore_errors: true
  when: k6_apt_available | bool

- name: Set k6 APT failure flag
  ansible.builtin.set_fact:
    k6_apt_failed: >-
      {{
        (k6_apt_available | bool and (k6_apt_install is failed))
        or (not (k6_apt_available | bool))
      }}

- name: Download k6 tarball (primary)
  ansible.builtin.get_url:
    url: "{{ k6_tarball_url }}"
    dest: "/tmp/k6.tar.gz"
    mode: "0644"
    timeout: 60
    force: true
  register: k6_tarball_primary
  retries: 3
  delay: 5
  until: k6_tarball_primary is succeeded
  ignore_errors: true
  when: k6_apt_failed | bool

- name: Download k6 tarball (fallback mirror)
  ansible.builtin.get_url:
    url: "{{ k6_tarball_url_fallback }}"
    dest: "/tmp/k6.tar.gz"
    mode: "0644"
    timeout: 60
    force: true
  register: k6_tarball_fallback
  retries: 3
  delay: 5
  until: k6_tarball_fallback is succeeded
  when:
    - k6_apt_failed | bool
    - k6_tarball_primary is failed

- name: Assert k6 tarball download succeeded
  ansible.builtin.assert:
    that:
      - (k6_tarball_primary is succeeded)
        or (k6_tarball_fallback is defined and k6_tarball_fallback is succeeded)
    fail_msg: "k6 tarball download failed from both primary and fallback URLs."
  when: k6_apt_failed | bool

- name: Extract k6 tarball
  ansible.builtin.unarchive:
    src: "/tmp/k6.tar.gz"
    dest: "/tmp"
    remote_src: true
  when: k6_apt_failed | bool

- name: Install k6 binary
  ansible.builtin.copy:
    src: "{{ k6_extract_dir }}/k6"
    dest: "/usr/local/bin/k6"
    mode: "0755"
    remote_src: true
  when: k6_apt_failed | bool

- name: Ensure k6 workspace root exists
  ansible.builtin.file:
    path: "{{ k6_workspace_root }}"
    state: directory
    mode: "0755"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
