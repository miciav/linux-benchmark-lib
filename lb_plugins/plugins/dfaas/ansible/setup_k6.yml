---
- name: Install k6 and prepare workspace
  hosts: all
  become: true
  vars:
    k6_workspace_root: "/var/lib/dfaas-k6"
    k6_key_url: "https://dl.k6.io/key.gpg"
    k6_keyring_path: "/usr/share/keyrings/k6-archive-keyring.gpg"
    k6_repo: "deb [signed-by={{ k6_keyring_path }}] https://dl.k6.io/deb stable main"
    k6_version: "0.49.0"
    k6_arch_map:
      x86_64: "amd64"
      amd64: "amd64"
      aarch64: "arm64"
      arm64: "arm64"
    k6_arch: "{{ k6_arch_map.get(ansible_facts['architecture'], 'amd64') }}"
    k6_tarball_url: "https://github.com/grafana/k6/releases/download/v{{ k6_version }}/k6-v{{ k6_version }}-linux-{{ k6_arch }}.tar.gz"
    k6_extract_dir: "/tmp/k6-v{{ k6_version }}-linux-{{ k6_arch }}"
  tasks:
    - name: Install apt dependencies
      ansible.builtin.apt:
        name:
          - ca-certificates
          - gnupg
        state: present
        update_cache: true

    - name: Ensure keyring directory exists
      ansible.builtin.file:
        path: "/usr/share/keyrings"
        state: directory
        mode: "0755"

    - name: Download k6 repository key
      ansible.builtin.get_url:
        url: "{{ k6_key_url }}"
        dest: "/tmp/k6-key.gpg"
        mode: "0644"

    - name: Install k6 repository key
      ansible.builtin.command: "gpg --dearmor -o {{ k6_keyring_path }} /tmp/k6-key.gpg"
      args:
        creates: "{{ k6_keyring_path }}"

    - name: Add k6 APT repository
      ansible.builtin.apt_repository:
        repo: "{{ k6_repo }}"
        filename: "k6"
        state: present

    - name: Install k6 via APT
      block:
        - name: Install k6
          ansible.builtin.apt:
            name: k6
            state: present
            update_cache: true
      rescue:
        - name: Download k6 tarball
          ansible.builtin.get_url:
            url: "{{ k6_tarball_url }}"
            dest: "/tmp/k6.tar.gz"
            mode: "0644"

        - name: Extract k6 tarball
          ansible.builtin.unarchive:
            src: "/tmp/k6.tar.gz"
            dest: "/tmp"
            remote_src: true

        - name: Install k6 binary
          ansible.builtin.copy:
            src: "{{ k6_extract_dir }}/k6"
            dest: "/usr/local/bin/k6"
            mode: "0755"
            remote_src: true

    - name: Ensure k6 workspace root exists
      ansible.builtin.file:
        path: "{{ k6_workspace_root }}"
        state: directory
        mode: "0755"
