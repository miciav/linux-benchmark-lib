---
# This playbook orchestrates the setup of BOTH the load generator (k6) and the benchmark targets.
# It requires `benchmark_config` to be passed as an extra var (provided by lb_controller).
#
# Architecture:
#   - Play 1: Register k6 host dynamically from benchmark_config
#   - Play 2: Install k6 on the k6_generators group
#   - Play 3: Configure benchmark targets (OpenFaaS, Prometheus, etc.)

- name: Register K6 Generator Host from Config
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    - name: Parse k6_host from config
      ansible.builtin.set_fact:
        k6_host_address: "{{ (benchmark_config.plugin_settings.dfaas.k6_host | default('')) }}"
        k6_user: "{{ (benchmark_config.plugin_settings.dfaas.k6_user | default('ubuntu')) }}"
        k6_ssh_key: "{{ (benchmark_config.plugin_settings.dfaas.k6_ssh_key | default('')) }}"
        k6_port: "{{ (benchmark_config.plugin_settings.dfaas.k6_port | default(22)) }}"

    - name: Add K6 host to inventory
      ansible.builtin.add_host:
        name: "{{ k6_host_address }}"
        groups: k6_generators
        ansible_user: "{{ k6_user }}"
        ansible_ssh_private_key_file: "{{ k6_ssh_key | regex_replace('^~', lookup('env', 'HOME')) }}"
        ansible_port: "{{ k6_port }}"
        ansible_ssh_common_args: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
        ansible_python_interpreter: "/usr/bin/python3"
      when: k6_host_address | length > 0

- name: Configure K6 Generator
  hosts: k6_generators
  become: true
  gather_facts: true
  vars_files:
    - vars/k6.yml
  tasks:
    - name: Install k6
      ansible.builtin.import_tasks: tasks/install_k6.yml

- name: Configure Benchmark Targets
  hosts: all:!k6_generators:!localhost
  become: true
  gather_facts: true
  vars_files:
    - vars/target.yml
  vars:
    # Make benchmark_config available with safe default
    benchmark_config: "{{ benchmark_config | default({}) }}"
  tasks:
    - name: Ensure .ssh directory exists for user
      ansible.builtin.file:
        path: "{{ ansible_facts['env']['HOME'] }}/.ssh"
        state: directory
        mode: "0700"
        owner: "{{ ansible_user }}"

    - name: Upload K6 SSH key to target
      ansible.builtin.copy:
        src: "{{ (benchmark_config.plugin_settings.dfaas.k6_ssh_key | default('')) | regex_replace('^~', lookup('env', 'HOME')) }}"
        dest: "{{ ansible_facts['env']['HOME'] }}/.ssh/dfaas_k6_key"
        mode: "0600"
        owner: "{{ ansible_user }}"
      when:
        - benchmark_config.plugin_settings.dfaas.k6_ssh_key is defined
        - (benchmark_config.plugin_settings.dfaas.k6_ssh_key | default('') | length > 0)

    - name: Override k6_ssh_key path for remote execution
      ansible.builtin.set_fact:
        benchmark_config: >-
          {{
            benchmark_config | combine({
              'plugin_settings': {
                'dfaas': benchmark_config.plugin_settings.dfaas | combine({
                  'k6_ssh_key': ansible_facts['env']['HOME'] ~ '/.ssh/dfaas_k6_key'
                })
              }
            }, recursive=True)
          }}
      when:
        - benchmark_config.plugin_settings.dfaas.k6_ssh_key is defined

    - name: Setup target infrastructure
      ansible.builtin.import_tasks: tasks/setup_target_tasks.yml
