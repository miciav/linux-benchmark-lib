---
# This playbook orchestrates the setup of BOTH the load generator (k6) and the benchmark targets (OpenFaaS/Prometheus).
# It requires `lb_config` to be passed as an extra var.

- name: Register K6 Generator Host from Config
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    - name: Parse k6_host from config
      ansible.builtin.set_fact:
        k6_host_address: "{{ (lb_config.plugin_settings.dfaas.k6_host | default('')) }}"
        k6_user: "{{ (lb_config.plugin_settings.dfaas.k6_user | default('ubuntu')) }}"
        k6_ssh_key: "{{ (lb_config.plugin_settings.dfaas.k6_ssh_key | default('')) }}"
        k6_port: "{{ (lb_config.plugin_settings.dfaas.k6_port | default(22)) }}"

    - name: Add K6 host to inventory
      add_host:
        name: "{{ k6_host_address }}"
        groups: k6_generators
        ansible_user: "{{ k6_user }}"
        ansible_ssh_private_key_file: "{{ k6_ssh_key | regex_replace('^~', lookup('env', 'HOME')) }}"
        ansible_port: "{{ k6_port }}"
        ansible_ssh_common_args: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
        ansible_python_interpreter: "/usr/bin/python3"
      when: k6_host_address | length > 0

- name: Configure K6 Generator
  hosts: k6_generators
  become: true
  gather_facts: true
  vars:
    k6_workspace_root: >-
      {{
        (ansible_user == 'root')
        | ternary('/root/.dfaas-k6', '/home/' ~ ansible_user ~ '/.dfaas-k6')
      }}
    # Variables extracted from setup_k6.yml
    k6_keyring_path: "/usr/share/keyrings/k6-archive-keyring.gpg"
    k6_keyserver: "hkp://keyserver.ubuntu.com:80"
    k6_key_fingerprint: "C5AD17C747E3415A3642D57D77C6C491D6AC1D69"
    k6_repo: "deb [signed-by={{ k6_keyring_path }}] https://dl.k6.io/deb stable main"
    k6_version: "0.49.0"
    k6_arch_map:
      x86_64: "amd64"
      amd64: "amd64"
      aarch64: "arm64"
      arm64: "arm64"
    k6_arch: "{{ k6_arch_map.get(ansible_facts['architecture'], 'amd64') }}"
    k6_tarball_url: "https://github.com/grafana/k6/releases/download/v{{ k6_version }}/k6-v{{ k6_version }}-linux-{{ k6_arch }}.tar.gz"
    k6_tarball_url_fallback: "https://dl.k6.io/releases/k6-v{{ k6_version }}-linux-{{ k6_arch }}.tar.gz"
    k6_extract_dir: "/tmp/k6-v{{ k6_version }}-linux-{{ k6_arch }}"
  tasks:
    - import_tasks: tasks/install_k6.yml

- name: Configure Benchmark Targets
  hosts: all:!k6_generators:!localhost
  become: true
  gather_facts: true
  vars:
    # Variables extracted from setup_target.yml
    k3s_version: ""
    k3s_install_exec: "--write-kubeconfig-mode 644"
    openfaas_namespace: "openfaas"
    openfaas_fn_namespace: "openfaas-fn"
    openfaas_gateway_node_port: 31112
    openfaas_admin_user: "admin"
    openfaas_gateway_url: ""
    prometheus_namespace: "openfaas"
    prometheus_node_port: 30411
    prometheus_url: ""
    prometheus_manifests_dir: "/tmp/dfaas-prometheus"
    scaphandre_enabled: false
    scaphandre_repo_url: ""
    scaphandre_repo_name: "scaphandre"
    scaphandre_chart: ""
    scaphandre_release: "scaphandre"
    # Note: k6 settings here are only for reference or if the target needs them (e.g. key auth)
    # The actual k6 installation happened in the previous play.
    benchmark_config: "{{ lb_config | default({}) }}"
  tasks:
    - import_tasks: tasks/setup_target_tasks.yml
