---
- name: Setup HPL (Simplified)
  hosts: all
  become: false
  tags: ['setup']

  vars:
    # Default install path (overridden by plugin logic usually)
    hpl_workspace: "{{ ansible_env.HOME }}/.lb/workspaces/hpl"
    hpl_version: "2.3"
    hpl_url: "http://www.netlib.org/benchmark/hpl/hpl-2.3.tar.gz"
    hpl_make_flags: "-j1"  # keep memory usage low during compile

  tasks:
    - name: Install System Dependencies (Debian/Ubuntu)
      ansible.builtin.package:
        name:
          - build-essential
          - gfortran
          - openmpi-bin
          - libopenmpi-dev
          - libopenblas-dev
          - wget
          - tar
          - make
        state: present
      become: true
      when: ansible_os_family == 'Debian'

    - name: Install System Dependencies (RedHat)
      ansible.builtin.package:
        name:
          - gcc
          - gcc-gfortran
          - openmpi
          - openmpi-devel
          - openblas-devel
          - wget
          - tar
          - make
        state: present
      become: true
      when: ansible_os_family == 'RedHat'

    - name: Ensure workspace exists
      ansible.builtin.file:
        path: "{{ hpl_workspace }}"
        state: directory
        mode: '0755'

    - name: Download HPL source
      ansible.builtin.get_url:
        url: "{{ hpl_url }}"
        dest: "{{ hpl_workspace }}/hpl-{{ hpl_version }}.tar.gz"
        mode: '0644'

    - name: Extract HPL
      ansible.builtin.unarchive:
        src: "{{ hpl_workspace }}/hpl-{{ hpl_version }}.tar.gz"
        dest: "{{ hpl_workspace }}"
        remote_src: true
        creates: "{{ hpl_workspace }}/hpl-{{ hpl_version }}/README"

    - name: Inject Make.Linux configuration
      ansible.builtin.copy:
        dest: "{{ hpl_workspace }}/hpl-{{ hpl_version }}/Make.Linux"
        content: |
          SHELL = /bin/sh
          ARCH  = Linux
          TOPdir = {{ hpl_workspace }}/hpl-{{ hpl_version }}
          INCdir = $(TOPdir)/include
          LIBdir = $(TOPdir)/lib/$(ARCH)
          BINDIR = $(TOPdir)/bin/$(ARCH)
          HPLlib = $(LIBdir)/libhpl.a
          
          CC      = mpicc
          LINKER  = mpicc
          CCFLAGS = -O3 -march=native -funroll-loops -fomit-frame-pointer
          LDFLAGS = -O3
          
          # OpenBLAS linkage
          BLASlib = -lopenblas
          MPIlib  = 
          MPIdir  =
          LIBS    = $(BLASlib) -lm
          
          INCLUDES = -I$(INCdir)

    - name: Compile HPL
      ansible.builtin.command: make arch=Linux
      args:
        chdir: "{{ hpl_workspace }}/hpl-{{ hpl_version }}"
        creates: "{{ hpl_workspace }}/hpl-{{ hpl_version }}/bin/Linux/xhpl"
      environment:
        MAKEFLAGS: "{{ hpl_make_flags }}"
