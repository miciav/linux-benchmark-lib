- name: Install HPL from prebuilt package
  hosts: all
  gather_facts: true
  become: true

  vars:
    lb_workdir: "{{ lb_workdir | default('/opt/lb') }}"
    hpl_version: "{{ hpl_version | default('2.3') }}"
    hpl_workspace: "{{ hpl_workspace | default(ansible_env.HOME + '/.lb/workspaces/hpl') }}"
    hpl_arch_map:
      x86_64: amd64
      amd64: amd64
      aarch64: arm64
      arm64: arm64
    hpl_deb_src: >-
      {{ hpl_deb_src
         | default(playbook_dir + '/../hpl_2.3-1_' + (hpl_arch_map.get(ansible_architecture, 'amd64')) + '.deb') }}
    hpl_deb_dest: "/tmp/hpl_{{ hpl_version }}.deb"
    hpl_packages:
      - python3
      - python3-venv
      - python3-pip
      - openmpi-bin
      - libopenmpi-dev
      - libopenblas-dev
      - procps
      - sysstat

  tasks:
    - name: Abort on unsupported OS family
      ansible.builtin.fail:
        msg: "HPL .deb install is supported on Debian/Ubuntu only."
      when: ansible_facts['os_family'] | default('') != 'Debian'

    - name: Install HPL runtime dependencies
      ansible.builtin.apt:
        name: "{{ hpl_packages }}"
        state: present
        update_cache: true

    - name: Validate HPL package source exists on controller
      delegate_to: localhost
      run_once: true
      ansible.builtin.stat:
        path: "{{ hpl_deb_src }}"
      register: hpl_deb_src_stat

    - name: Fail if HPL package is missing
      ansible.builtin.fail:
        msg: >-
          HPL .deb not found at {{ hpl_deb_src }}.
          Override hpl_deb_src with a valid path or URL.
      when: not hpl_deb_src_stat.stat.exists

    - name: Copy HPL package to target
      ansible.builtin.copy:
        src: "{{ hpl_deb_src }}"
        dest: "{{ hpl_deb_dest }}"
        mode: "0644"

    - name: Install HPL package
      ansible.builtin.apt:
        deb: "{{ hpl_deb_dest }}"
        state: present
        update_cache: true

    - name: Ensure workspace bin directory exists
      ansible.builtin.file:
        path: "{{ hpl_workspace }}/hpl-{{ hpl_version }}/bin/Linux"
        state: directory
        mode: "0755"
        owner: "{{ ansible_user | default('root') }}"
        group: "{{ ansible_user | default('root') }}"

    - name: Copy xhpl into workspace for convenience
      ansible.builtin.copy:
        src: "/opt/hpl-{{ hpl_version }}/bin/Linux/xhpl"
        dest: "{{ hpl_workspace }}/hpl-{{ hpl_version }}/bin/Linux/xhpl"
        mode: "0755"
        remote_src: true

    - name: Ensure benchmark workdir exists
      ansible.builtin.file:
        path: "{{ lb_workdir }}"
        state: directory
        mode: "0755"

    - name: Check for project sources
      ansible.builtin.stat:
        path: "{{ lb_workdir }}/pyproject.toml"
      register: lb_pyproject

    - name: Check for virtualenv pip
      ansible.builtin.stat:
        path: "{{ lb_workdir }}/.venv/bin/pip"
      register: lb_venv_pip

    - name: Install linux-benchmark-lib (editable)
      ansible.builtin.command:
        cmd: "{{ (lb_venv_pip.stat.exists | ternary(lb_workdir + '/.venv/bin/pip', 'pip3')) }} install -e ."
        chdir: "{{ lb_workdir }}"
      when: lb_pyproject.stat.exists

    - name: Warn if project sources are missing
      ansible.builtin.debug:
        msg: "Skipping linux-benchmark-lib install: {{ lb_workdir }}/pyproject.toml not found"
      when: not lb_pyproject.stat.exists
