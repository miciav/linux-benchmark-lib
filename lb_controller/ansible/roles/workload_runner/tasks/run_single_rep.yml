- name: Set workload repetition context
  ansible.builtin.set_fact:
    workload_runner_current_workload: "{{ workload_item[0] }}"
    workload_runner_current_rep: "{{ workload_item[1] | int }}"
    workload_runner_total_reps: >-
      {{
        (workload_runner_reps | length)
        if workload_runner_reps is defined and (workload_runner_reps | length) > 0
        else (workload_runner_repetitions_total | default(1) | int)
      }}
    run_prefix: "[run:{{ inventory_hostname }}:{{ workload_item[0] }}]"

- name: "{{ run_prefix }} Emit start event for repetition"
  ansible.builtin.debug:
    msg: >-
      LB_EVENT {{
        {
          "run_id": run_id | default(""),
          "host": inventory_hostname,
          "workload": workload_runner_current_workload,
          "repetition": workload_runner_current_rep,
          "total_repetitions": workload_runner_total_reps,
          "status": "running"
        } | to_json
      }}

- name: Run workload repetition via LocalRunner
  block:
    - name: "{{ run_prefix }} Execute {{ workload_runner_current_workload }} repetition {{ workload_runner_current_rep }}"
      ansible.builtin.shell: |
        set -e
        export PYTHONUNBUFFERED=1
        "{{ lb_workdir | default('/opt/lb') }}/.venv/bin/python" - <<'PY'
        import json
        import sys
        import time
        from pathlib import Path

        from lb_runner.benchmark_config import BenchmarkConfig
        from lb_runner.local_runner import LocalRunner
        from lb_controller.services.plugin_service import create_registry

        cfg_path = Path("{{ workload_runner_workdir }}/benchmark_config.generated.json")
        cfg = BenchmarkConfig.from_dict(json.loads(cfg_path.read_text()))

        runner = LocalRunner(
            cfg,
            registry=create_registry(),
            progress_callback=None,
            host_name="{{ inventory_hostname }}",
        )

        start = time.time()
        success = runner.run_benchmark(
            "{{ workload_runner_current_workload }}",
            repetition_override={{ workload_runner_current_rep }},
            total_repetitions={{ workload_runner_total_reps }},
            run_id="{{ run_id }}",
        )
        duration = time.time() - start
        payload = {
            "run_id": "{{ run_id }}",
            "host": "{{ inventory_hostname }}",
            "workload": "{{ workload_runner_current_workload }}",
            "repetition": {{ workload_runner_current_rep }},
            "total_repetitions": {{ workload_runner_total_reps }},
            "status": "done" if success else "failed",
            "message": f"duration={duration:.1f}s",
        }
        print("LB_EVENT " + json.dumps(payload), flush=True)
        if not success:
            sys.exit(1)
        PY
      args:
        chdir: "{{ workload_runner_workdir }}"
      environment:
        LB_RUN_HOST: "{{ inventory_hostname }}"
      register: workload_runner_rep_result
      changed_when: true

    - name: "{{ run_prefix }} Collect workload artifacts for repetition"
      ansible.builtin.include_tasks: collect_workload.yml

    - name: Emit completion event for repetition
      ansible.builtin.debug:
        msg: >-
          LB_EVENT {{
            {
              "run_id": run_id | default(""),
              "host": inventory_hostname,
              "workload": workload_runner_current_workload,
              "repetition": workload_runner_current_rep,
              "total_repetitions": workload_runner_total_reps,
              "status": "done"
            } | to_json
          }}
      when: workload_runner_rep_result.rc == 0

    - name: "{{ run_prefix }} Cooldown between repetitions (pure, collectors stopped)"
      ansible.builtin.pause:
        seconds: "{{ workload_runner_config_rendered.cooldown_seconds | default(0) | int }}"
      when:
        - (workload_runner_config_rendered.cooldown_seconds | default(0) | int) > 0
        - workload_runner_reps is defined
        - workload_runner_current_rep != (workload_runner_reps | last)

  rescue:
    - name: "{{ run_prefix }} Emit failure event for repetition"
      ansible.builtin.debug:
        msg: >-
          LB_EVENT {{
            {
              "run_id": run_id | default(""),
              "host": inventory_hostname,
              "workload": workload_runner_current_workload,
              "repetition": workload_runner_current_rep,
              "total_repetitions": workload_runner_total_reps,
              "status": "failed",
              "message": (workload_runner_rep_result.stderr | default(workload_runner_rep_result.stdout | default(''))) | string
            } | to_json
          }}
    - name: "{{ run_prefix }} Collect workload artifacts for failed repetition"
      ansible.builtin.include_tasks: collect_workload.yml
      vars:
        workload_runner_collect_ignore_errors: true
    - name: Fail workload repetition
      ansible.builtin.fail:
        msg: >-
          Workload {{ workload_runner_current_workload }} repetition {{ workload_runner_current_rep }} failed (rc={{ workload_runner_rep_result.rc | default('unknown') }})
