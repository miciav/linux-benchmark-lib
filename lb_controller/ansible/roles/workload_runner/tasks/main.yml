- name: Select workload runner mode
  debug:
    msg: >-
      Workload runner mode={{ workload_runner_mode | default('execute') }}
      tests={{ workload_runner_tests | default([]) }}
      output={{ workload_runner_output_dir | default('/tmp') }}
      lb_workdir={{ lb_workdir | default('/opt/lb') }}

- name: Define workload runner workdir (use globally installed lb_workdir)
  set_fact:
    workload_runner_workdir: "{{ lb_workdir | default('/opt/lb') }}"
    workload_runner_uv_bin: >-
      {{
        lb_uv_bin
        | default((lb_workdir | default('/opt/lb')) + '/.local/bin/uv')
      }}
    setup_prefix: "[setup]"
    run_prefix: "[run]"

- name: "{{ setup_prefix }} Ensure workload output directory exists"
  ansible.builtin.file:
    path: "{{ workload_runner_output_dir | default('/tmp') }}"
    state: directory
    mode: "0755"

- name: "{{ run_prefix }} Prepare benchmark configuration for this host"
  set_fact:
    workload_runner_config_rendered: >-
      {{
        (workload_runner_config | default({}))
        | combine({
            'output_dir': workload_runner_output_dir | default('/tmp'),
            'report_dir': (workload_runner_output_dir | default('/tmp')) ~ '/reports',
            'data_export_dir': (workload_runner_output_dir | default('/tmp')) ~ '/exports',
          }, recursive=True)
      }}

- name: "{{ run_prefix }} Collect static system information (JSON + CSV)"
  ansible.builtin.shell: |
    set -e
    export PYTHONUNBUFFERED=1
    "{{ workload_runner_uv_bin }}" run python -m lb_runner.services.system_info \
      --json "{{ workload_runner_output_dir | default('/tmp') }}/system_info.json" \
      --csv "{{ workload_runner_output_dir | default('/tmp') }}/system_info.csv"
  args:
    chdir: "{{ workload_runner_workdir }}"
  register: workload_runner_sysinfo
  changed_when: true
  when:
    - workload_runner_mode == "execute"

- name: "{{ run_prefix }} Write benchmark configuration file"
  ansible.builtin.copy:
    dest: "{{ workload_runner_workdir }}/benchmark_config.generated.json"
    content: "{{ workload_runner_config_rendered | to_nice_json }}"
    mode: "0644"

- name: "{{ run_prefix }} Build repetitions list"
  set_fact:
    workload_runner_reps: >-
      {{
        workload_runner_pending_reps
        if workload_runner_pending_reps is defined and (workload_runner_pending_reps | length) > 0
        else (
          (range(1, (workload_runner_repetitions_total | int) + 1) | list)
          if (workload_runner_repetitions_total | int) > 0 else [1]
        )
      }}
  when:
    - workload_runner_mode == "execute"

- name: "{{ run_prefix }} Run workload per repetition (separate tasks)"
  ansible.builtin.include_tasks: run_single_rep.yml
  # Use built-in product filter to avoid external lookup dependency
  loop: "{{ (workload_runner_tests | default([])) | product(workload_runner_reps | default([1])) | list }}"
  loop_control:
    loop_var: workload_item
    label: "{{ workload_item[0] }} rep {{ workload_item[1] }}"
  when:
    - workload_runner_mode == "execute"
