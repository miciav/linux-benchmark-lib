- name: Prepare benchmark hosts
  hosts: all
  gather_facts: true
  become: true

  vars:
    run_id: "{{ run_id | default('unknown') }}"
    use_container_fallback: "{{ use_container_fallback | default(false) }}"
    # Define a consistent workdir for the benchmark library on remote hosts
    lb_workdir: "/opt/lb"

  tasks:
    - name: Ensure deadsnakes PPA present for Python 3.12 (Debian/Ubuntu)
      ansible.builtin.apt_repository:
        repo: ppa:deadsnakes/ppa
        state: present
      register: _python_ppa
      until: _python_ppa is succeeded
      retries: 3
      delay: 5
      when: ansible_facts['os_family'] | default('') == 'Debian'
      tags: python

    - name: Update apt cache when PPA added
      ansible.builtin.apt:
        update_cache: true
      when:
        - ansible_facts['os_family'] | default('') == 'Debian'
        - _python_ppa is defined and _python_ppa is changed
      tags: python

    - name: Ensure base packages are installed (Python 3.12, venv, pip)
      package:
        name:
          - python3.12
          - python3.12-venv
          - python3
          - python3-pip
          - python3-venv
        state: present
        update_cache: true

    - name: Install collector dependencies (APT)
      ansible.builtin.apt:
        name: "{{ (collector_apt_packages | default([])) + ['pciutils', 'smartmontools'] }}"
        state: present
        update_cache: true
      when:
        - ansible_facts['os_family'] | default('') == 'Debian'
      tags: deps

    - name: Define Python interpreter for the virtual environment
      ansible.builtin.shell: |
        set -e
        if command -v python3.12 >/dev/null 2>&1; then
          command -v python3.12
        else
          command -v python3
        fi
      register: lb_python_bin
      changed_when: false

    - name: Create benchmark library workdir on remote host
      ansible.builtin.file:
        path: "{{ lb_workdir }}"
        state: directory
        mode: "0755"

    - name: Create virtual environment for benchmark library
      ansible.builtin.command:
        cmd: "{{ (lb_python_bin.stdout or 'python3') }} -m venv {{ lb_workdir }}/.venv"
        creates: "{{ lb_workdir }}/.venv/bin/python"

    - name: Synchronize benchmark library sources to remote host
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../../../{{ item }}"
        dest: "{{ lb_workdir }}/"
        mode: preserve
      loop:
        - lb_runner
        - lb_controller
        - lb_ui
        - pyproject.toml
        - uv.lock

    - name: Upgrade pip inside virtual environment
      ansible.builtin.command:
        cmd: "{{ lb_workdir }}/.venv/bin/pip install --upgrade pip"
        chdir: "{{ lb_workdir }}"

    - name: Install benchmark library in editable mode
      ansible.builtin.command:
        cmd: "{{ lb_workdir }}/.venv/bin/pip install -e ."
        chdir: "{{ lb_workdir }}"

    - name: Ensure benchmark output directory exists
      ansible.builtin.file:
        path: "{{ output_root }}"
        state: directory
        mode: "0755"
