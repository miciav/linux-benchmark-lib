- name: Prepare benchmark hosts
  hosts: all
  gather_facts: true
  become: true

  vars:
    run_id: "{{ run_id | default('unknown') }}"
    use_container_fallback: "{{ use_container_fallback | default(false) }}"
    # Define a consistent workdir for the benchmark library on remote hosts
    lb_workdir: "/opt/lb"
    lb_uv_install_dir: "{{ lb_workdir }}/.local/bin"
    lb_uv_bin: "{{ lb_uv_install_dir }}/uv"
    lb_uv_python_version: "3.12"
    lb_uv_install_script: "{{ lb_workdir }}/uv-install.sh"
    lb_apt_cache_valid_time: 3600
    lb_src_root: "{{ playbook_dir }}/../../.."

  tasks:
    - name: Install collector dependencies (APT)
      ansible.builtin.apt:
        name: "{{ (collector_apt_packages | default([])) + ['pciutils', 'smartmontools'] }}"
        state: present
        update_cache: true
        cache_valid_time: "{{ lb_apt_cache_valid_time }}"
      when:
        - ansible_facts['os_family'] | default('') == 'Debian'
      tags: deps

    - name: Create benchmark library workdir on remote host
      ansible.builtin.file:
        path: "{{ lb_workdir }}"
        state: directory
        mode: "0755"

    - name: Ensure uv install directory exists
      ansible.builtin.file:
        path: "{{ lb_uv_install_dir }}"
        state: directory
        mode: "0755"

    - name: Check for uv binary
      ansible.builtin.stat:
        path: "{{ lb_uv_bin }}"
      register: lb_uv_stat

    - name: Download uv install script
      ansible.builtin.get_url:
        url: https://astral.sh/uv/install.sh
        dest: "{{ lb_uv_install_script }}"
        mode: "0755"
      when: not lb_uv_stat.stat.exists

    - name: Install uv
      ansible.builtin.command:
        cmd: "{{ lb_uv_install_script }}"
      environment:
        UV_INSTALL_DIR: "{{ lb_uv_install_dir }}"
        UV_NO_MODIFY_PATH: "1"
      when: not lb_uv_stat.stat.exists

    - name: Remove uv install script
      ansible.builtin.file:
        path: "{{ lb_uv_install_script }}"
        state: absent
      when: not lb_uv_stat.stat.exists

    - name: Create local archive for benchmark library sources
      ansible.builtin.tempfile:
        state: file
        suffix: ".tar.gz"
      register: lb_src_archive
      delegate_to: localhost
      become: false
      run_once: true

    - name: Store local archive path for all hosts
      ansible.builtin.set_fact:
        lb_src_archive_path: "{{ lb_src_archive.path }}"
      delegate_to: localhost
      delegate_facts: true
      become: false
      run_once: true

    - name: Build benchmark library archive locally
      ansible.builtin.command:
        cmd: >-
          tar -czf {{ hostvars['localhost'].lb_src_archive_path }}
          -C {{ lb_src_root }}
          lb_app lb_analytics lb_common lb_controller lb_plugins lb_provisioner lb_runner lb_ui
          pyproject.toml README.md uv.lock
      delegate_to: localhost
      changed_when: true
      become: false
      run_once: true

    - name: Upload benchmark library archive
      ansible.builtin.copy:
        src: "{{ hostvars['localhost'].lb_src_archive_path }}"
        dest: "{{ lb_workdir }}/lb_src.tar.gz"
        mode: "0644"

    - name: Extract benchmark library archive on remote host
      ansible.builtin.unarchive:
        src: "{{ lb_workdir }}/lb_src.tar.gz"
        dest: "{{ lb_workdir }}/"
        remote_src: true

    - name: Remove remote benchmark library archive
      ansible.builtin.file:
        path: "{{ lb_workdir }}/lb_src.tar.gz"
        state: absent

    - name: Remove local benchmark library archive
      ansible.builtin.file:
        path: "{{ hostvars['localhost'].lb_src_archive_path }}"
        state: absent
      delegate_to: localhost
      become: false
      run_once: true

    - name: Create uv virtual environment for benchmark library
      ansible.builtin.command:
        cmd: "{{ lb_uv_bin }} venv --python {{ lb_uv_python_version }} .venv"
        chdir: "{{ lb_workdir }}"
        creates: "{{ lb_workdir }}/.venv/bin/python"

    - name: Sync benchmark dependencies with uv (no dev)
      ansible.builtin.command:
        cmd: "{{ lb_uv_bin }} sync --frozen --no-dev"
        chdir: "{{ lb_workdir }}"

    - name: Ensure benchmark output directory exists
      ansible.builtin.file:
        path: "{{ output_root }}"
        state: directory
        mode: "0755"
