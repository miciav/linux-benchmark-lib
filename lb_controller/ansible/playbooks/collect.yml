- name: Collect benchmark artifacts
  hosts: all
  gather_facts: false
  become: false

  vars:
    run_id: "{{ run_id | default('unknown') }}"
    remote_output_root: "{{ remote_output_root | default('/tmp/benchmark_results') }}"
    data_export_root: "{{ data_export_root | default('/tmp/data_exports') }}"
    per_host_output: "{{ per_host_output | default({}) }}"
    output_root: "{{ output_root | default('./benchmark_results') }}"
    plugin_assets_dict: "{{ benchmark_config.plugin_assets | default({}) }}"

  pre_tasks:
    - name: "Derive plugin-specific collect pre tasks"
      include_tasks: "{{ item.value.collect_pre_playbook }}"
      loop: "{{ plugin_assets_dict | dict2items }}"
      when:
        - item.value.collect_pre_playbook is defined
        - item.value.collect_pre_playbook | default('', true) | length > 0
        - item.key in (benchmark_config.workloads | default({}))
      loop_control:
        label: "{{ item.key }}"

  tasks:
    - name: Ensure local host output dir exists
      ansible.builtin.file:
        path: "{{ per_host_output[inventory_hostname] | default(output_root ~ '/' ~ inventory_hostname) }}"
        state: directory
        mode: "0755"
      delegate_to: localhost
      run_once: false

    - name: Fetch system info artifacts (JSON + CSV)
      ansible.builtin.fetch:
        src: "{{ remote_output_root }}/{{ inventory_hostname }}/{{ item }}"
        dest: "{{ per_host_output[inventory_hostname] | default(output_root ~ '/' ~ inventory_hostname) }}/"
        flat: true
      loop:
        - system_info.json
        - system_info.csv

    - name: Ensure controller log output dir exists
      ansible.builtin.file:
        path: "{{ output_root }}/logs"
        state: directory
        mode: "0755"
      delegate_to: localhost
      become: false
      run_once: false

    - name: Find JSONL logs on remote host
      ansible.builtin.find:
        paths: "{{ remote_output_root }}/{{ inventory_hostname }}"
        patterns: "*.jsonl"
        recurse: true
        file_type: file
      register: workload_runner_log_files
      failed_when: false
      changed_when: false

    - name: Fetch JSONL logs to controller
      ansible.builtin.fetch:
        src: "{{ item.path }}"
        dest: "{{ output_root }}/logs/"
        flat: true
      loop: "{{ workload_runner_log_files.files | default([]) }}"
      loop_control:
        label: "{{ item.path | default('') }}"
      failed_when: false

    - name: Check LB_EVENT stream log exists
      ansible.builtin.stat:
        path: "{{ remote_output_root }}/{{ inventory_hostname }}/lb_events.stream.log"
      register: lb_events_stream_log
      failed_when: false
      changed_when: false

    - name: Fetch LB_EVENT stream log to controller
      ansible.builtin.fetch:
        src: "{{ remote_output_root }}/{{ inventory_hostname }}/lb_events.stream.log"
        dest: "{{ output_root }}/logs/lb_events-{{ inventory_hostname }}.stream.log"
        flat: true
      when: lb_events_stream_log.stat.exists
      failed_when: false

    - name: Collect plugin-specific logs (post)
      include_tasks: "{{ item.value.collect_post_playbook }}"
      loop: "{{ plugin_assets_dict | dict2items }}"
      when:
        - item.value.collect_post_playbook is defined
        - item.value.collect_post_playbook | default('', true) | length > 0
        - item.key in (benchmark_config.workloads | default({}))
      loop_control:
        label: "{{ item.key }}"
