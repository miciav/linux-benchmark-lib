- name: Collect benchmark artifacts
  hosts: all
  gather_facts: false
  become: false

  vars:
    run_id: "{{ run_id | default('unknown') }}"
    remote_output_root: "{{ remote_output_root | default('/tmp/benchmark_results') }}"
    data_export_root: "{{ data_export_root | default('/tmp/data_exports') }}"
    per_host_output: "{{ per_host_output | default({}) }}"
    output_root: "{{ output_root | default('./benchmark_results') }}"

  pre_tasks:
    - name: Derive DFaaS k6 settings from benchmark config
      ansible.builtin.set_fact:
        dfaas_k6_host: >-
          {{
            (
              (benchmark_config.plugin_settings | default({})).dfaas | default({})
            )
            .k6_host | default('')
          }}
        dfaas_k6_user: >-
          {{
            (
              (benchmark_config.plugin_settings | default({})).dfaas | default({})
            )
            .k6_user | default('ubuntu')
          }}
        dfaas_k6_ssh_key: >-
          {{
            (
              (benchmark_config.plugin_settings | default({})).dfaas | default({})
            )
            .k6_ssh_key | default('')
          }}
        dfaas_k6_port: >-
          {{
            (
              (benchmark_config.plugin_settings | default({})).dfaas | default({})
            )
            .k6_port | default(22)
          }}
        dfaas_k6_workspace_root: >-
          {{
            (
              (benchmark_config.plugin_settings | default({})).dfaas | default({})
            )
            .k6_workspace_root | default('/home/ubuntu/.dfaas-k6')
          }}
        dfaas_k6_ssh_key_path: >-
          {{
            (
              (dfaas_k6_ssh_key | default('') | length > 0)
            )
            | ternary(
                dfaas_k6_ssh_key | regex_replace('^~', lookup('env', 'HOME')),
                ''
              )
          }}
      delegate_to: localhost
      run_once: true
      when:
        - benchmark_config is defined

    - name: Register DFaaS k6 host
      ansible.builtin.add_host:
        name: "dfaas_k6"
        ansible_host: "{{ dfaas_k6_host }}"
        ansible_user: "{{ dfaas_k6_user }}"
        ansible_port: "{{ dfaas_k6_port }}"
        ansible_ssh_private_key_file: >-
          {{
            (dfaas_k6_ssh_key_path | length > 0)
            | ternary(dfaas_k6_ssh_key_path, omit)
          }}
        ansible_ssh_common_args: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
        k6_workspace_root: "{{ dfaas_k6_workspace_root }}"
      delegate_to: localhost
      run_once: true
      when:
        - dfaas_k6_host is defined
        - dfaas_k6_host | length > 0

  tasks:
    - name: Ensure local host output dir exists
      ansible.builtin.file:
        path: "{{ per_host_output[inventory_hostname] | default(output_root ~ '/' ~ inventory_hostname) }}"
        state: directory
        mode: "0755"
      delegate_to: localhost
      run_once: false

    - name: Fetch system info artifacts (JSON + CSV)
      ansible.builtin.fetch:
        src: "{{ remote_output_root }}/{{ inventory_hostname }}/{{ item }}"
        dest: "{{ per_host_output[inventory_hostname] | default(output_root ~ '/' ~ inventory_hostname) }}/"
        flat: true
      loop:
        - system_info.json
        - system_info.csv

    - name: Ensure controller log output dir exists
      ansible.builtin.file:
        path: "{{ output_root }}/logs"
        state: directory
        mode: "0755"
      delegate_to: localhost
      become: false
      run_once: false

    - name: Find JSONL logs on remote host
      ansible.builtin.find:
        paths: "{{ remote_output_root }}/{{ inventory_hostname }}"
        patterns: "*.jsonl"
        recurse: true
        file_type: file
      register: workload_runner_log_files
      failed_when: false
      changed_when: false

    - name: Fetch JSONL logs to controller
      ansible.builtin.fetch:
        src: "{{ item.path }}"
        dest: "{{ output_root }}/logs/"
        flat: true
      loop: "{{ workload_runner_log_files.files | default([]) }}"
      loop_control:
        label: "{{ item.path | default('') }}"
      failed_when: false

    - name: Check LB_EVENT stream log exists
      ansible.builtin.stat:
        path: "{{ remote_output_root }}/{{ inventory_hostname }}/lb_events.stream.log"
      register: lb_events_stream_log
      failed_when: false
      changed_when: false

    - name: Fetch LB_EVENT stream log to controller
      ansible.builtin.fetch:
        src: "{{ remote_output_root }}/{{ inventory_hostname }}/lb_events.stream.log"
        dest: "{{ output_root }}/logs/lb_events-{{ inventory_hostname }}.stream.log"
        flat: true
      when: lb_events_stream_log.stat.exists
      failed_when: false

- name: Collect DFaaS k6 logs
  hosts: dfaas_k6
  gather_facts: false
  become: false

  vars:
    output_root: "{{ output_root | default('./benchmark_results') }}"

  tasks:
    - name: Find k6 logs on generator host
      ansible.builtin.find:
        paths: "{{ k6_workspace_root }}"
        patterns: "k6.log"
        recurse: true
        file_type: file
      register: k6_log_files
      failed_when: false
      changed_when: false

    - name: Fetch k6 logs to controller
      ansible.builtin.fetch:
        src: "{{ item.path }}"
        dest: "{{ output_root }}/logs/k6/{{ inventory_hostname }}/"
        flat: false
      loop: "{{ k6_log_files.files | default([]) }}"
      loop_control:
        label: "{{ item.path | default('') }}"
      failed_when: false
