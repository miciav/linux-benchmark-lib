- name: Collect benchmark artifacts
  hosts: all
  gather_facts: false
  become: false

  vars:
    run_id: "{{ run_id | default('unknown') }}"
    remote_output_root: "{{ remote_output_root | default('/tmp/benchmark_results') }}"
    data_export_root: "{{ data_export_root | default('/tmp/data_exports') }}"
    per_host_output: "{{ per_host_output | default({}) }}"

  tasks:
    - name: Ensure local host output dir exists
      ansible.builtin.file:
        path: "{{ per_host_output[inventory_hostname] | default(output_root ~ '/' ~ inventory_hostname) }}"
        state: directory
        mode: "0755"
      delegate_to: localhost
      run_once: false

    - name: Fetch system info artifacts (JSON + CSV)
      ansible.builtin.fetch:
        src: "{{ remote_output_root }}/{{ inventory_hostname }}/{{ item }}"
        dest: "{{ per_host_output[inventory_hostname] | default(output_root ~ '/' ~ inventory_hostname) }}/"
        flat: true
      loop:
        - system_info.json
        - system_info.csv
